<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„è®ºç®¡ç†</title>
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <script src="static/js/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wangeditor@4.6.16/dist/wangEditor.min.js"></script>
    <style>
        .comment-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-item {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .comment-item button {
            margin-left: 10px;
        }

        .like-button {
            color: gray;
            font-size: 20px;
            cursor: pointer;
        }

        .like-button.active {
            color: yellow;
        }

        .comment-item img {
            width: 100px;
            height: auto;
            margin-left: 15px;
        }

        .no-comment {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .modal-body input, .modal-body select, .modal-body textarea {
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div th:object="${session.currentUser}">
        <input type="hidden" th:value="*{uid}" id="LoginUid" />
    </div>
    <h2>è¯„è®ºç®¡ç†</h2>

    <!-- å‘å¸ƒè¯„è®º -->
    <div class="mb-3">
        <h4>å‘å¸ƒè¯„è®º</h4>
        <div id="editor-container"></div>
        <button id="addCommentBtn" class="btn btn-primary mt-2">å‘å¸ƒè¯„è®º</button>
    </div>

    <!-- æŸ¥çœ‹è¯„è®º -->
    <div class="mb-3">
        <h4>è¯„è®ºåˆ—è¡¨</h4>
        <div id="commentList" class="comment-list">
            <!-- å¦‚æœè¯„è®ºä¸ºç©ºæ˜¾ç¤ºæç¤ºå›¾ç‰‡ -->
            <div id="noComment" class="no-comment">
                <img src="static/img/Comment/nullComment.png" alt="No Comments">
            </div>
            <!-- è¯„è®ºé¡¹ -->
        </div>
    </div>

    <!-- ä¸¾æŠ¥è¯„è®ºæ¨¡æ€æ¡† -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">ä¸¾æŠ¥è¯„è®º</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <select id="reportCategory" class="form-control">
                        <option value="dislike">æˆ‘ä¸å–œæ¬¢</option>
                        <option value="FalseInformation">è™šå‡ä¿¡æ¯</option>
                        <option value="Infringement">ä¾µçŠ¯æƒç›Š</option>
                        <option value="SexualLewd">è‰²æƒ…ä½ä¿—</option>
                        <option value="CyberBullying">ç½‘ç»œæš´åŠ›</option>
                        <option value="politically sensitive">æ”¿æ²»æ•æ„Ÿ</option>
                        <option value="delinquency">è¿æ³•çŠ¯ç½ª</option>
                        <option value="else">å…¶ä»–</option>
                    </select>
                    <textarea id="reportReason" class="form-control" rows="5" placeholder="è¯·è¾“å…¥ä¸¾æŠ¥åŸå› ..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" id="submitReport" class="btn btn-primary">æäº¤ä¸¾æŠ¥</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // æ¨¡æ‹Ÿå½“å‰ç™»å½•çš„ç”¨æˆ·ID
        const  currentUserId = $("#LoginUid").val();
        console.log("è¡¨å•æ•°æ®ï¼š", currentUserId);
        let editor = new wangEditor('#editor-container');
        editor.create();

        // å‘å¸ƒè¯„è®º
        $("#addCommentBtn").click(function() {
            const content = editor.txt.html();
            if (content.trim()) {
                $.ajax({
                    url: "/comment/add",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        uid: currentUserId,
                        content: editor.getText(),
                        created: new Date(),
                        type: "Comment"
                    }),
                    success: function(response) {
                        alert("è¯„è®ºå‘å¸ƒæˆåŠŸï¼");
                        loadComments();
                        editor.txt.clear();  // æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹
                    },
                    error: function() {
                        alert("å‘å¸ƒè¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
                    }
                });
            }
        });

        // æŸ¥çœ‹è¯„è®º
        function loadComments() {
            console.log("currentUserIdï¼š", currentUserId);
            $.ajax({
                url: "/comment/listByUid",  // è¿™é‡Œæ˜¯ URL å‚æ•°å½¢å¼
                type: "GET",
                data: { uid: currentUserId },  // ä½¿ç”¨æŸ¥è¯¢å‚æ•°ä¼ é€’ uid
                success: function(response) {
                    const commentList = $("#commentList");
                    const noComment = $("#noComment");
                    commentList.empty();
                    if (response.length === 0) {
                        noComment.show();
                    } else {
                        noComment.hide();
                        response.forEach(function(comment) {
                            const likeClass = comment.agree > 0 ? 'like-button active' : 'like-button';
                            const commentItem = `
                        <div class="comment-item" id="comment-${comment.cid}">
                            <div>
                                <strong>è¯„è®ºå†…å®¹ï¼š</strong> ${comment.content}
                            </div>
                            <button class="like-button ${likeClass}" onclick="likeComment(${comment.cid})">ğŸ‘</button>
                            <span id="agreeCount-${comment.cid}">${comment.agree}</span>
                            <button class="btn btn-sm btn-info" onclick="replyComment(${comment.cid}, '${comment.uid}')">å›å¤</button>
                            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#reportModal" onclick="setReportComment(${comment.cid})">ä¸¾æŠ¥</button>
                        </div>
                    `;
                            commentList.append(commentItem);
                        });
                    }
                }
            });
        }


        // ç‚¹èµè¯„è®º
        window.likeComment = function(cid) {
            $.ajax({
                url: "/comment/like",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ cid: cid, uid: currentUserId }),
                success: function(response) {
                    $(`#comment-${cid} .like-button`).addClass('active');
                    $(`#agreeCount-${cid}`).text(parseInt($(`#agreeCount-${cid}`).text()) + 1);
                },
                error: function() {
                    alert("ç‚¹èµå¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
                }
            });
        };

        // å›å¤è¯„è®º
        window.replyComment = function(cid, uid) {
            const replyContent = `@${uid}ï¼š`;
            editor.txt.html(replyContent);
            $('html, body').animate({ scrollTop: $('#commentContent').offset().top }, 500);
        };

        // è®¾ç½®ä¸¾æŠ¥è¯„è®º
        window.setReportComment = function(cid) {
            $('#submitReport').off('click').on('click', function() {
                const category = $('#reportCategory').val();
                const reason = $('#reportReason').val();
                $.ajax({
                    url: "/comment/report",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        reporter: currentUserId,
                        cid: cid,
                        category: category,
                        reason: reason
                    }),
                    success: function(response) {
                        alert("ä¸¾æŠ¥æˆåŠŸï¼");
                        $('#reportModal').modal('hide');
                    },
                    error: function() {
                        alert("ä¸¾æŠ¥å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
                    }
                });
            });
        };

        // åˆæ¬¡åŠ è½½è¯„è®ºåˆ—è¡¨
        loadComments();
    });
</script>
</body>
</html>
