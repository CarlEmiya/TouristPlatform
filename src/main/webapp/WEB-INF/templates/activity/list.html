<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>活动列表</title>

    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/activity/list.css">
    <link rel="stylesheet" href="/static//css/bootstrap.min.css">
    <script src="/static/js/jquery-3.4.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <base th:href="@{/}">

</head>
<body>
<div class="container">
    <h1>所有活动</h1>
    <input type="hidden" id="userId" th:value="${session.currentUser.uid}" />
    <!-- 筛选表单 -->
    <form th:action="@{/travelActivity/list}" method="get" class="form-inline" id="filterForm">
        <div class="form-group">
            <label for="keyword">标题关键字</label>
            <input type="text" id="keyword" name="keyword" class="form-control" th:value="${keyword}">
        </div>

        <div class="form-group">
            <label for="status">活动状态</label>
            <select id="status" name="status" class="form-control">
                <option value="" th:selected="${status == null}">全部</option>
                <option value="1" th:selected="${status == 1}">未开始</option>
                <option value="4" th:selected="${status == 4}">组团中</option>
                <option value="5" th:selected="${status == 5}">已成团</option>
                <option value="6" th:selected="${status == 6}">活动进行中</option>
                <option value="7" th:selected="${status == 7}">已取消</option>
                <option value="16" th:selected="${status == 16}">已结束</option>
            </select>
        </div>

        <div class="form-group">
            <label for="timeInterval">时间筛选</label>
            <select id="timeInterval" name="timeInterval" class="form-control">
                <option value="" th:selected="${timeInterval == null}">全部</option>
                <option value="1" th:selected="${timeInterval == 1}">最近一个月</option>
                <option value="3" th:selected="${timeInterval == 3}">最近三个月</option>
                <option value="6" th:selected="${timeInterval == 6}">最近半年</option>
                <option value="12" th:selected="${timeInterval == 12}">最近一年</option>
            </select>
        </div>

<!--        //根据aLabel筛选-->
        <div class="form-group">
            <div class="form-group">
                <label for="aLabel">标签关键字</label>
                <input type="text" id="aLabel" name="aLabel" class="form-control" th:value="${aLabel}">
            </div>
        </div>


        <div class="form-group">
            <div class="form-group">
                <label for="publisherId">发布者ID：</label>
                <input type="text" id="publisherId" name="publisherId" class="form-control" th:value="${publisherId}">
            </div>
        </div>

        <div class="form-group">
            <div class="form-group">
                <label for="participantId">参与者ID：</label>
                <input type="text" id="participantId" name="participantId" class="form-control" th:value="${participantId}">
            </div>
        </div>


        <button type="submit" class="btn btn-primary">筛选</button>
        <button type="submit" class="btn btn-info" id="BtnMyActivities" > 我发布的活动</button>
        <button type="submit" class="btn btn-info" id="BtnMyAttendedActivities" > 我参加活动</button>
        <!-- 取消筛选按钮，如果有筛选条件时显示 -->
        <button type="button" class="btn btn-secondary" th:if="${keyword != null or status != null or timeInterval != null || aLabel != null || uidForMyActivities != null || MyAttendedActivities != null}"
                onclick="clearFilters()">取消筛选</button>
    </form>
    <!--        //点击取消筛选按钮，console输出当前筛选条件-->
    <hr />

    <div id="feedbackModal" class="modal" tabindex="-1" role="dialog" style="display:none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">反馈消息</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="feedbackMessage">这里是反馈信息</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 活动列表 -->
    <div class="activity-list-container">
        <ul class="list-group" th:if="${not #lists.isEmpty(activities)}">
            <li th:each="activity : ${activities}" class="list-group-item">
                <!-- 整个li作为超链接 -->
                <a th:href="@{/travelActivity/detail(aid=${activity.aid})}" class="d-flex align-items-center">

                    <!-- 左侧显示活动图片 -->
                    <img th:src="${activity.firstFilePath != null ? activity.firstFilePath : '/static/img/activity/default.gif'}"
                         class="activity-image" alt="活动图片"
                         style="width: 100px; height: 100px; object-fit: cover; margin-right: 15px;">
                    <!-- 右侧显示标题、描述、状态 -->
                    <div class="activity-info">
                        <h5 th:text="${activity.title}"></h5>
                        <p th:text="${activity.description}"></p>
                        <div th:text="'活动id：'+${activity.aid}" />
                        <p th:text="'状态: ' + ${activity.status == 1 ? '进行中' : (activity.status == 16 ? '已结束' : '已取消')}"></p>
                    </div>
                </a>
<!--                如果session.currentUser.uid == activity.uid:，那么显示这些按钮-->
                <div th:if="${session.currentUser.uid == activity.uid || session.currentUser.identify == 1}">
                    <form action="/travelActivity/TotalDelete" method="post" class="deleteForm">
                        <input type="hidden" id="deleteActivityAid" name="aid" th:value="${activity.aid}" />
                        <button type="submit" class="btn btn-danger"  >删除</button>
                    </form>
                </div>

                <!--                如果session.currentUser.uid == activity.uid:，那么显示这些按钮-->
                <div th:if="${session.currentUser.uid == activity.uid || session.currentUser.identify == 1}">
                    <!-- 封禁按钮 -->
                    <form action="/travelActivity/updateStatus" method="post" class="banForm">
                        <input type="hidden" id="banActivityAid" name="aid" th:value="${activity.aid}" />
                        <input type="hidden" id="banStatus" name="newStatus" value="2" />  <!-- 封禁状态 -->
                        <button type="submit" class="btn btn-primary" >封禁</button>
                    </form>
                </div>
                <div th:if="${session.currentUser.identify == 1}">

                    <!-- 恢复按钮 -->
                    <form action="/travelActivity/updateStatus" method="post" class="restoreForm">
                        <input type="hidden" id="RecoveryActivityAid" name="aid" th:value="${activity.aid}" />
                        <input type="hidden" id="restoreStatus" name="newStatus" value="6" />  <!-- 恢复状态 -->

                        <button type="submit" class="btn btn-primary" >恢复</button>
                    </form>
                </div>
            </li>
        </ul>


        <!-- 如果没有活动，则显示图片 -->
        <div th:if="${#lists.isEmpty(activities)}" class="no-activities">
            <img src="/static/img/activity/noActivity.png" alt="No activities available">
        </div>
    </div>

    <p th:text="'用户等级：'+${session.currentUser.level}">111111111111111</p>
    <p th:text="'用户id：'+${session.currentUser.uid}">111111111111111</p>
    <!-- 发布活动按钮 -->
    <div th:if="${session.currentUser.level >= 3}">
        <a href="/travelActivity/publish" class="btn btn-primary">发布活动</a>
    </div>

    <div th:if="${not #lists.isEmpty(activities)}">
        <div class="pagination-container">
            <ul class="pagination">
                <!-- 首页 -->
                <li th:class="${pageInfo.pageNum == 1} ? 'disabled' : ''">
                    <a href="#" th:href="@{/travelActivity/list(pageNo=1, pageSize=${pageInfo.pageSize}, keyword=${keyword}, status=${status}, timeInterval=${timeInterval},aLable=${aLabel}, uidForMyActivities=${uidForMyActivities}, MyAttendedActivities=${MyAttendedActivities} ,publisherId=${publisherId},participantId=${participantId}   )}">首页</a>
                </li>

                <!-- 上一页 -->
                <li th:class="${pageInfo.pageNum == 1} ? 'disabled' : ''">
                    <a href="#" th:href="@{/travelActivity/list(pageNo=${pageInfo.pageNum - 1}, pageSize=${pageInfo.pageSize}, keyword=${keyword}, status=${status}, timeInterval=${timeInterval},aLable=${aLabel},uidForMyActivities=${uidForMyActivities}, MyAttendedActivities=${MyAttendedActivities},publisherId=${publisherId},participantId=${participantId}   )}">&laquo;</a>
                </li>

                <!-- 页码范围 -->
                <li th:each="i : ${#numbers.sequence(pageInfo.pageNum - 2, pageInfo.pageNum + 2)}"
                    th:if="${i > 0 and i <= pageInfo.pages}">
                    <a href="#" th:href="@{/travelActivity/list(pageNo=${i}, pageSize=${pageInfo.pageSize}, keyword=${keyword}, status=${status}, timeInterval=${timeInterval},aLable=${aLabel},uidForMyActivities=${uidForMyActivities}, MyAttendedActivities=${MyAttendedActivities},publisherId=${publisherId},participantId=${participantId}   )}"
                       th:text="${i}"
                       th:class="${i == pageInfo.pageNum} ? 'active' : ''"></a>
                </li>

                <!-- 下一页 -->
                <li th:class="${pageInfo.pageNum == pageInfo.pages} ? 'disabled' : ''">
                    <a href="#" th:href="@{/travelActivity/list(pageNo=${pageInfo.pageNum + 1}, pageSize=${pageInfo.pageSize}, keyword=${keyword}, status=${status}, timeInterval=${timeInterval},aLable=${aLabel},uidForMyActivities=${uidForMyActivities}, MyAttendedActivities=${MyAttendedActivities},publisherId=${publisherId},participantId=${participantId}   )}">&raquo;</a>
                </li>

                <!-- 尾页 -->
                <li th:class="${pageInfo.pageNum == pageInfo.pages} ? 'disabled' : ''">
                    <a href="#" th:href="@{/travelActivity/list(pageNo=${pageInfo.pages}, pageSize=${pageInfo.pageSize}, keyword=${keyword}, status=${status}, timeInterval=${timeInterval},aLable=${aLabel},uidForMyActivities=${uidForMyActivities}, MyAttendedActivities=${MyAttendedActivities} ,publisherId=${publisherId},participantId=${participantId}   )}">尾页</a>
                </li>
            </ul>
        </div>
    </div>
</div>


<script>
    // 使用 Ajax 请求来删除活动
    $(".deleteForm").submit(function(e) {
        e.preventDefault();  // 阻止表单默认提交
        var aid = $(this).find('input[name="aid"]').val();  // 获取隐藏字段的 aid
        console.log("删除：" + aid);

        $.ajax({
            url: '/travelActivity/TotalDelete',  // URL 路径与后端控制器匹配
            type: 'POST',  // 使用 POST 请求方法
            data: { aid: aid },  // 传递 aid 参数
            success: function(response) {
                console.log(response);  // 打印返回的响应
                showFeedbackMessage('活动删除成功！', 'success');
            },
            error: function(xhr, status, error) {
                console.error(xhr, status, error);  // 打印错误信息
                showFeedbackMessage('活动删除失败，请重试。', 'error');
            }
        });
    });

    // 使用 Ajax 请求来封禁活动
    $(".banForm").submit(function(e) {
        e.preventDefault();  // 阻止表单默认提交
        var aid = $(this).find('input[name="aid"]').val();
        var newStatus = $(this).find('input[name="newStatus"]').val();  // 获取封禁状态
        console.log("封禁：" + aid);

        $.ajax({
            url: '/travelActivity/updateStatus',  // 更新状态的 URL
            type: 'POST',
            data: { aid: aid, newStatus: newStatus },  // 传递活动的 ID 和封禁状态
            success: function(response) {
                showFeedbackMessage('活动封禁成功！', 'success');
            },
            error: function() {
                showFeedbackMessage('活动封禁失败，请重试。', 'error');
            }
        });
    });

    // 使用 Ajax 请求来恢复活动
    $(".restoreForm").submit(function(e) {
        e.preventDefault();  // 阻止表单默认提交
        var aid = $(this).find('input[name="aid"]').val();
        var newStatus = $(this).find('input[name="newStatus"]').val();  // 获取恢复状态
        console.log("恢复：" + aid);

        $.ajax({
            url: '/travelActivity/updateStatus',  // 更新状态的 URL
            type: 'POST',
            data: { aid: aid, newStatus: newStatus },  // 传递活动的 ID 和恢复状态
            success: function(response) {
                showFeedbackMessage('活动恢复成功！', 'success');
            },
            error: function() {
                showFeedbackMessage('活动恢复失败，请重试。', 'error');
            }
        });
    });



    function showFeedbackMessage(message, status) {
        // 设置模态框的消息内容
        var feedbackElement = document.getElementById("feedbackMessage");
        feedbackElement.innerText = message;

        // 根据状态设置消息的样式
        if (status == "success") {
            feedbackElement.style.color = "green";
        } else {
            feedbackElement.style.color = "red";
        }

        // 显示模态框
        document.getElementById('feedbackModal').style.display = 'block';
        setTimeout("location.reload()", 1800);
    }
</script>

<script>

    function clearFilters() {
        window.location.href = '/travelActivity/list'; // 刷新页面，去掉所有筛选条件
    }



    document.getElementById('BtnMyActivities').addEventListener('click', function() {
        // 获取具有特定 id 的表单
        var form = document.getElementById('filterForm');
        var hiddenField = document.createElement('input');
        var userId = document.getElementById('userId').value;

        console.log(userId);
        console.log("--------------------------------------------");
        console.log(form);

        // 创建隐藏字段
        hiddenField.type = 'hidden';
        hiddenField.name = 'uidForMyActivities';
        hiddenField.value = userId;  // 使用 session 中的 currentUser 或其他方式获取当前用户的 ID

        // 将隐藏字段添加到表单中
        form.appendChild(hiddenField);

        // 提交表单
        form.submit();
    });

    document.getElementById('BtnMyAttendedActivities').addEventListener('click', function() {
        // 获取具有特定 id 的表单
        var form = document.getElementById('filterForm');
        var hiddenField = document.createElement('input');
        var userId = document.getElementById('userId').value;

        // 创建隐藏字段
        hiddenField.type = 'hidden';
        hiddenField.name = 'MyAttendedActivities';
        hiddenField.value = userId;  // 使用 session 中的 currentUser 或其他方式获取当前用户的 ID

        // 将隐藏字段添加到表单中
        form.appendChild(hiddenField);

        // 提交表单
        form.submit();
    });


</script>
</body>

</html>
