<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<!--<html lang="en">-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论管理</title>
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <script src="static/js/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="static/css/jquery-ui.min.css">
    <script src="static/js/wangEditor.min.js"></script>
    <style>
        .comment-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 50px;
            height: auto;
            border-radius: 50%;
        }

        .username {
            font-weight: bold;
        }

        .comment-body {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .comment-text {
            font-size: 14px;
            flex-grow: 1;
            text-align: left;
        }

        .comment-footer {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time {
            color: #888;
            font-size: 0.9em;
        }

        .location {
            color: #888;
            font-size: 0.9em;
        }

        .star-rating {
            color: #f90;
            font-weight: bold;
        }

        .like-button {
            background-color: transparent;
            border: none;
            color: #007bff;
            cursor: pointer;
        }

        .like-button.active {
            color: gold;
            font-weight: bold;
        }

        .btn {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .btn-link {
            color: #007bff;
            text-decoration: none;
        }

        .btn-danger {
            background-color: #dc3545;
            border: none;
            color: white;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            border: none;
            color: black;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
            color: white;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1040;
            background-color: transparent;
        }
        /*.modal-backdrop{*/
        /*    background-color: transparent;*/
        /*}*/
    </style>
    <script src="/static/js/bootstrap.bundle.min.js"></script>

</head>
<body>
<div class="container mt-5">
    <div th:object="${session.currentUser}">
        <input type="hidden" th:value="*{uid}" id="LoginUid" />
        <input type="hidden" th:value="*{identify}" id="identity" />
    </div>
    <h2>评论管理</h2>



    <!-- 查看评论 -->
    <div class="mb-3">
        <h4>评论列表</h4>
        <div id="commentList" class="comment-list">
            <!-- 如果评论为空显示提示图片 -->
            <div id="noComment" class="no-comment">
                <img src="static/img/Comment/nullComment.png" alt="No Comments">
            </div>
        </div>
        <div id="pagination">
            <ul class="pagination"></ul>
        </div>

    </div>




    <!-- 发布评论 -->
    <div class="mb-3">
        <h4>发布评论</h4>
        <div id="editor-container"></div>
        <button id="addCommentBtn" class="btn btn-primary mt-2">发布评论</button>
    </div>



    <!-- 举报评论模态框 -->
    <div class="modal" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">举报评论</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 举报类别选择 -->
                    <select id="reportCategory" class="form-control">
                        <option value="dislike">我不喜欢</option>
                        <option value="FalseInformation">虚假信息</option>
                        <option value="Infringement">侵犯权益</option>
                        <option value="SexualLewd">色情低俗</option>
                        <option value="CyberBullying">网络暴力</option>
                        <option value="politicallySensitive">政治敏感</option>
                        <option value="delinquency">违法犯罪</option>
                        <option value="else">其他</option>
                    </select>
                    <!-- wangEditor 编辑器 -->
                    <div id="reportEditor"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" id="submitReport" class="btn btn-primary">提交举报</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑评论模态框 -->
    <div class="modal" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCommentModalLabel">编辑评论</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- wangEditor 编辑器 -->
                    <div id="updateEditor"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" id="saveEdit" class="btn btn-primary">保存更改</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 清空指定人的评论 -->
<div class="mb-3">
    <label for="clearCommentsUid" class="form-label">输入要清空评论的用户ID：</label>
    <div class="input-group">
        <input type="text" id="clearCommentsUid" class="form-control" placeholder="用户ID">
        <button id="clearCommentsBtn" class="btn btn-danger">清空评论</button>
    </div>
</div>




<script>
    const currentUserId = $("#LoginUid").val();
    // 当前页码和每页记录数
    let currentPage = 1;
    const pageSize = 5;

    function formatDate(dateString) {
        const date = new Date(dateString); // 将时间字符串转换为 Date 对象
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 月份从0开始，需要加1并补零
        const day = String(date.getDate()).padStart(2, '0'); // 补零到两位

        return `${year}-${month}-${day}`;
    }

    function formatCity(city) {
        // 截取城市前两位
        return city.substring(0, 2);
    }

    function formatRate(rate) {
        // console.log("评分：", rate);
        // 格式化评分1-10分
        if (rate >= 1 && rate <= 10) {
            //得到json，返回原样的text字符串
            return rate;
        }
    }

    // 删除单条评论
    function deleteComment(cid) {
        if (confirm("确定要删除这条评论吗？")) {
            $.ajax({
                url: "/comment/deleteByCid",
                type: "DELETE",
                contentType: "application/json",  // 设置请求内容类型为 JSON
                data: JSON.stringify({ cid: cid }),  // 将请求数据转换为 JSON 格式
                success: function(response) {
                    if (response === 1) {  // 假设后端返回 1 表示成功
                        // alert("评论已删除！");
                        // 刷新页面
                        window.location.reload();
                    } else {
                        alert("删除失败！");
                    }
                },
                error: function(xhr, status, error) {
                    alert("删除失败！请重试。");
                    console.error(error);  // 输出详细错误信息
                }
            });
        }
    }


    function ReportComment(cid) {
        // 保存评论 ID
        currentCid = cid;
        // console.log("举报评论ID:", currentCid); // 可用此行调试，确认 CID 已经传入

        // 初始化 WangEditor 编辑器
        const reportEditor = new wangEditor('#reportEditor');
        reportEditor.create();  // 创建编辑器
    }



    // 编辑评论函数
    function editComment(cid) {
        // 获取当前评论内容
        const commentContent = document.getElementById(`commentContent-${cid}`).textContent;

        // 初始化 wangEditor
        const updateEditor = new wangEditor('#updateEditor');
        updateEditor.create();

        // 填充评论内容到编辑器
        updateEditor.setContent(commentContent);

        // 保存编辑后的内容
        document.getElementById('saveEdit').onclick = function() {
            // 获取编辑后的内容
            const updatedContent = updateEditor.getHtml(); // 获取HTML内容

            // 创建一个包含评论ID和内容的请求数据
            const data = JSON.stringify({
                cid: cid,
                content: updatedContent
            });

            // 发送请求到后端
            fetch('/comment/update', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: data
            })
                .then(response => response.json())
                .then(result => {
                    if (result === 1) {
                        // 更新成功后刷新评论列表或修改DOM
                        alert('评论已更新');
                        window.location.reload();
                        $('#editCommentModal').modal('hide'); // 关闭模态框
                    } else {
                        alert('更新失败');
                    }
                })
                .catch(error => {
                    alert('发生错误');
                });
        };
    }

    function updatePagination(pageInfo) {
        const pagination = $("#pagination ul.pagination");
        pagination.empty();

        const { pageNum, pages, hasPreviousPage, hasNextPage, navigateFirstPage, navigateLastPage, navigatepageNums } = pageInfo;

        // console.log("分页导航数据：", pageInfo);

        // 添加 "首页" 按钮
        if (pageNum > 1) {
            pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadComments(currentUserId, 1)">首页</a></li>`);
        } else {
            pagination.append(`<li class="page-item disabled"><span class="page-link">首页</span></li>`);
        }

        // 添加 "上一页" 按钮
        if (hasPreviousPage) {
            pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadComments(currentUserId, ${pageNum - 1})">上一页</a></li>`);
        } else {
            pagination.append(`<li class="page-item disabled"><span class="page-link">上一页</span></li>`);
        }

        // 动态生成页码按钮，当前页前后最多显示3个页码
        const maxPagesToShow = 3;
        const startPage = Math.max(1, pageNum - maxPagesToShow);
        const endPage = Math.min(pages, pageNum + maxPagesToShow);

        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === pageNum ? 'active' : '';
            pagination.append(`<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="loadComments(currentUserId, ${i})">${i}</a></li>`);
        }

        // 添加 "下一页" 按钮
        if (hasNextPage) {
            pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadComments(currentUserId, ${pageNum + 1})">下一页</a></li>`);
        } else {
            pagination.append(`<li class="page-item disabled"><span class="page-link">下一页</span></li>`);
        }

        // 添加 "尾页" 按钮
        if (pageNum < pages) {
            pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadComments(currentUserId, ${pages})">尾页</a></li>`);
        } else {
            pagination.append(`<li class="page-item disabled"><span class="page-link">尾页</span></li>`);
        }
    }


    function toggleComment(cid) {
        const contentSpan = document.querySelector(`#commentContent-${cid}`);
        const moreButton = document.querySelector(`#moreButton-${cid}`);
        const fullContent = document.querySelector(`#comment-${cid}`).getAttribute('data-full-content');

        // 判断当前是否为短文本显示
        const isShort = moreButton.textContent === '更多';

        if (isShort) {
            // 展开全文
            contentSpan.textContent = fullContent;
            moreButton.textContent = '收缩';
        } else {
            // 收缩为前50个字符
            contentSpan.textContent = fullContent.substring(0, 50) + '...';
            moreButton.textContent = '更多';
        }
    }


    // 点赞/取消点赞评论
    const likeComment = function(cid) {
        // console.log("来自点赞：点赞评论：", cid);
        // console.log("来自点赞：当前用户ID：", currentUserId);

        // 获取按钮和点赞数的元素
        const likeButton = $(`#comment-${cid} .like-button`);
        const agreeCount = $(`#agreeCount-${cid}`);

        // 判断按钮是否已经是 active 状态
        const isLiked = likeButton.hasClass('active');

        if (isLiked) {
            // 取消点赞操作
            // console.log("取消点赞");

            // 发送取消点赞请求
            $.ajax({
                url: "/comment/unlike", // 假设有取消点赞的接口
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    cid: Number(cid), // 强制转换为数字
                    uid: Number(currentUserId) // 强制转换为数字
                }),
                success: function(response) {
                    // 更新UI：按钮变灰，点赞数减1
                    likeButton.removeClass('active'); // 移除 active 类
                    agreeCount.text(parseInt(agreeCount.text()) - 1); // 点赞数减1
                },
                error: function(xhr, status, error) {
                    console.error("取消点赞失败：", xhr.responseText || error);
                    alert("取消点赞失败，请重试！");
                }
            });
        } else {
            // 点赞操作
            // console.log("点赞");
            // 发送点赞请求
            $.ajax({
                url: "/comment/like",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    cid: Number(cid), // 强制转换为数字
                    uid: Number(currentUserId) // 强制转换为数字
                }),
                success: function(response) {
                    // 更新UI：按钮变为活跃状态，点赞数加1
                    likeButton.addClass('active'); // 添加 active 类
                    agreeCount.text(parseInt(agreeCount.text()) + 1); // 点赞数加1
                },
                error: function(xhr, status, error) {
                    console.error("点赞失败：", xhr.responseText || error);
                    alert("点赞失败，请重试！");
                }
            });
        }
    };


    // 回复评论
    const replyComment = function(cid, uid, name) {
        // 编辑器内容中预填充回复文本
        const replyContent = `@${name}：`;
        editor.txt.html(replyContent);  // 在编辑器中显示回复内容

        // 确保 #commentContent 元素存在并且有有效的 offset()
        const commentContent = $(`#commentContent-${cid}`);
        if (commentContent.length > 0) {
            // 使用动画滚动到评论内容
            $('html, body').animate({ scrollTop: commentContent.offset().top }, 500);
        } else {
            console.error('找不到评论内容元素');
        }
    };


    // 加载评论列表
    function loadComments(uid = currentUserId, pageNo = 1) {
        $.ajax({
            url: "/comment/listByUid",
            type: "GET",
            data: { uid: uid, pageNo: pageNo, pageSize: pageSize },
            success: function(response) {
                const commentList = $("#commentList");
                const noComment = $("#noComment");

                commentList.empty();
                const comments = response.list;

                if (comments.length === 0) {
                    noComment.show();
                } else {
                    noComment.hide();
                    const userIds = comments.map(comment => comment.uid);

                    // 获取用户信息并渲染评论
                    $.ajax({
                        url: "/comment/getUsers",
                        type: "GET",
                        data: { uids: userIds.join(",") },
                        success: function(userMap) {
                            comments.forEach(function(comment) {
                                const user = userMap[comment.uid] || { name: "匿名用户", picture: "/static/img/default.png", city: "" };
                                const formattedDate = formatDate(comment.created);
                                const rate = formatRate(comment.rate);
                                const likeClass = comment.agree > 0 ? 'like-button active' : 'like-button';

                                const shortContent = comment.content.length > 200 ? comment.content.substring(0, 200) + '...' : comment.content;
                                const fullContent = comment.content;

                                const commentItem = `
<div class="comment-item" id="comment-${comment.cid}" data-full-content="${fullContent}">
    <div class="comment-header" style="display: flex; align-items: center;">
        <img class="user-avatar" src="${user.picture}" alt="头像" />
        <span class="username">${user.name}</span>
    </div>
    <div class="comment-body" style="display: flex; align-items: center; gap: 20px; margin-top: 10px;">
        <div class="comment-text" style="flex-grow: 1;">
            <div>
                <span id="commentContent-${comment.cid}" class="comment-content">${shortContent}</span>
            </div>
            <div>
                <button class="btn btn-sm btn-link" id="moreButton-${comment.cid}" onclick="toggleComment(${comment.cid})">更多</button>
            </div>
        </div>
    </div>
            <div class="comment-footer" style="display: flex; align-items: center; gap: 10px;">
                <span class="time">${formattedDate}</span>
                <p class="location">${user.city || ''}</p>
                <span class="star-rating">${rate}分</span>
                <button class="like-button ${likeClass}" onclick="likeComment(${comment.cid})">点赞</button>
                <span id="agreeCount-${comment.cid}">${comment.agree}</span>
                <button class="btn btn-sm btn-info" onclick="replyComment(${comment.cid}, '${comment.uid}', '${user.name}')">回复</button>
                ${currentUserId == comment.uid ? `
                    <button class="btn btn-sm btn-danger" onclick="deleteComment(${comment.cid})">删除</button>
                    <button class="btn btn-sm btn-primary" onclick="editComment(${comment.cid})">编辑</button>
                ` : ''}
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#reportModal" onclick="ReportComment(${comment.cid})">举报</button>
            </div>

</div>
                            `;
                                commentList.append(commentItem);
                            });
                            updatePagination(response);
                        }
                    });
                }
            }
        });
    }




    $(document).ready(function() {
        // 模拟当前登录的用户ID

        // console.log("表单数据：", currentUserId);
        let editor = new wangEditor('#editor-container');
        editor.create();

        // 发布评论
        $("#addCommentBtn").click(function() {
            const content = editor.txt.html();
            if (content.trim()) {
                $.ajax({
                    url: "/comment/add",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        uid: currentUserId,
                        content: editor.getText(),
                        created: new Date(),
                        type: "Comment"
                    }),
                    success: function(response) {
                        alert("评论发布成功！");
                        window.location.reload();  // 刷新页面
                        editor.txt.clear();  // 清空编辑器内容
                    },
                    error: function() {
                        alert("发布评论失败，请重试！");
                    }
                });
            }
        });



        // 清空指定人的评论
        $(document).ready(function() {
            $("#clearCommentsBtn").click(function() {
                const uid = $("#clearCommentsUid").val().trim();
                if (!uid) {
                    alert("请输入有效的用户ID！");
                    return;
                }

                if (confirm(`确定要清空用户 ${uid} 的所有评论吗？`)) {
                    $.ajax({
                        url: `/comment/deleteAllByUid?uid=${uid}`, // 将 uid 放在 URL 参数中
                        type: "DELETE",
                        success: function(response) {
                            if (response.message === "success") {
                                alert(`用户 ${uid} 的所有评论已成功删除！`);
                                window.location.reload(); // 重新加载评论
                            } else {
                                alert("清空评论失败：" + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            alert("操作失败，请稍后重试！");
                            console.error(error);
                        }
                    });
                }
            });

        });














        // 提交举报
        document.getElementById('submitReport').onclick = function() {
            const category = document.getElementById('reportCategory').value; // 获取举报类别
            const reason = reportEditor.getText(); // 获取举报理由
            const data = JSON.stringify({
                reporter: $("#LoginUid").val(),
                cid: cid, // 评论ID
                category: category,
                reason: reason
            });

            fetch('/comment/report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: data
            })
                .then(response => response.json())
                .then(result => {
                    alert('举报成功');
                    $('#reportModal').modal('hide'); // 关闭模态框
                })
                .catch(error => {
                    alert('举报失败');
                });
        };








        // 初次加载评论列表
        loadComments();
    });
</script>

</body>
</html>
